{"version":3,"file":"submit-addon.js","names":["createWriteStream","promises","fsPromises","pipeline","promisify","fetch","FormData","fileFromSync","Response","SignJWT","createLogger","log","import","meta","url","JwtApiAuth","apiKey","apiSecret","apiJwtExpiresIn","constructor","signJWT","iss","setProtectedHeader","alg","setIssuedAt","setExpirationTime","sign","Uint8Array","from","Buffer","getAuthHeader","authToken","Client","apiAuth","baseUrl","validationCheckInterval","validationCheckTimeout","approvalCheckInterval","approvalCheckTimeout","downloadDir","process","cwd","apiUrl","URL","path","nodeFetch","method","headers","body","doUploadSubmit","xpiPath","channel","formData","set","uuid","fetchJson","waitForValidation","waitRetry","successFunc","checkUrl","checkInterval","abortInterval","context","checkTimeout","Promise","resolve","reject","abortTimeout","setTimeout","clearTimeout","Error","pollStatus","responseData","undefined","success","err","info","detailResponseData","processed","validation","valid","doNewAddonSubmit","metaDataJson","jsonData","version","upload","JSON","stringify","doNewAddonOrVersionSubmit","addonId","waitForApproval","versionId","file","status","errorMsg","response","statusText","data","json","ok","href","Authorization","Accept","downloadSignedFile","fileUrl","filename","pathname","split","pop","dest","saveToFile","error","id","downloadedFiles","contents","destPath","postNewAddon","savedIdPath","saveIdToFileFunc","saveIdToFile","uploadUuid","versionObject","guid","newVersionId","putVersion","results","signAddon","amoBaseUrl","timeout","SubmitClient","ApiAuthClass","stats","stat","isFile","statError","client","filePath","writeFile","toString","join","debug"],"sources":["../../src/util/submit-addon.js"],"sourcesContent":["/* @flow */\nimport { createWriteStream, promises as fsPromises } from 'fs';\nimport { pipeline } from 'stream';\nimport { promisify } from 'util';\n\n// eslint-disable-next-line no-shadow\nimport fetch, { FormData, fileFromSync, Response } from 'node-fetch';\nimport { SignJWT } from 'jose';\n\nimport {createLogger} from './../util/logger.js';\n\nconst log = createLogger(import.meta.url);\n\nexport type SignResult = {|\n  id: string,\n  downloadedFiles: Array<string>,\n|};\n\nexport interface ApiAuth {\n  getAuthHeader(): Promise<string>\n}\n\nexport class JwtApiAuth {\n  #apiKey: string;\n  #apiSecret: string;\n  #apiJwtExpiresIn: number;\n\n  constructor({\n    apiKey,\n    apiSecret,\n    apiJwtExpiresIn = 60 * 5, // 5 minutes\n  }: {apiKey: string, apiSecret: string, apiJwtExpiresIn?: number}) {\n    this.#apiKey = apiKey;\n    this.#apiSecret = apiSecret;\n    this.#apiJwtExpiresIn = apiJwtExpiresIn;\n  }\n\n  async signJWT(): Promise<string> {\n    return new SignJWT({ iss: this.#apiKey })\n      .setProtectedHeader({ alg: 'HS256' })\n      .setIssuedAt()\n      // jose expects either:\n      // a number, which is treated an absolute timestamp - so must be after now, or\n      // a string, which is parsed as a relative time from now.\n      .setExpirationTime(`${this.#apiJwtExpiresIn}seconds`)\n      .sign(Uint8Array.from(Buffer.from(this.#apiSecret, 'utf8')));\n  }\n\n  async getAuthHeader(): Promise<string> {\n    const authToken = await this.signJWT();\n    return `JWT ${authToken}`;\n  }\n}\n\ntype ClientConstructorParams = {|\n  apiAuth: ApiAuth,\n  baseUrl: URL,\n  validationCheckInterval?: number,\n  validationCheckTimeout?: number,\n  approvalCheckInterval?: number,\n  approvalCheckTimeout?: number,\n  downloadDir?: string,\n|};\n\nexport default class Client {\n  apiAuth: ApiAuth;\n  apiUrl: URL;\n  validationCheckInterval: number;\n  validationCheckTimeout: number;\n  approvalCheckInterval: number;\n  approvalCheckTimeout: number;\n  downloadDir: string;\n\n  constructor({\n    apiAuth,\n    baseUrl,\n    validationCheckInterval = 1000,\n    validationCheckTimeout = 300000, // 5 minutes.\n    approvalCheckInterval = 1000,\n    approvalCheckTimeout = 900000, // 15 minutes.\n    downloadDir = process.cwd(),\n  }: ClientConstructorParams) {\n    this.apiAuth = apiAuth;\n    this.apiUrl = new URL('addons/', baseUrl);\n    this.validationCheckInterval = validationCheckInterval;\n    this.validationCheckTimeout = validationCheckTimeout;\n    this.approvalCheckInterval = approvalCheckInterval;\n    this.approvalCheckTimeout = approvalCheckTimeout;\n    this.downloadDir = downloadDir;\n  }\n\n  fileFromSync(path: string): File {\n    return fileFromSync(path);\n  }\n\n  nodeFetch(\n    url: URL,\n    { method, headers, body }: {\n      method: string,\n      headers: { [key: string]: string },\n      body?: typeof FormData | string\n    }\n  ): Promise<typeof Response> {\n    return fetch(url, { method, headers, body });\n  }\n\n  async doUploadSubmit(xpiPath: string, channel: string): Promise<string> {\n    const url = new URL('upload/', this.apiUrl);\n    const formData = new FormData();\n    formData.set('channel', channel);\n    formData.set('upload', this.fileFromSync(xpiPath));\n    const { uuid } = await this.fetchJson(url, 'POST', formData);\n    return this.waitForValidation(uuid);\n  }\n\n  waitRetry(\n    successFunc: (detailResponseData: any) => string | null,\n    checkUrl: URL,\n    checkInterval: number,\n    abortInterval: number,\n    context: string,\n  ): Promise<string> {\n    let checkTimeout;\n\n    return new Promise((resolve, reject) => {\n      const abortTimeout = setTimeout(() => {\n        clearTimeout(checkTimeout);\n        reject(new Error(`${context}: timeout.`));\n      }, abortInterval);\n\n      const pollStatus = async () => {\n        try {\n          const responseData = await this.fetchJson(\n            checkUrl, 'GET', undefined, 'Getting details failed.');\n\n          const success = successFunc(responseData);\n          if (success) {\n            clearTimeout(abortTimeout);\n            resolve(success);\n          } else {\n            // Still in progress, so wait for a while and try again.\n            checkTimeout = setTimeout(pollStatus, checkInterval);\n          }\n        } catch (err) {\n          clearTimeout(abortTimeout);\n          reject(err);\n        }\n      };\n\n      pollStatus();\n    });\n  }\n\n  waitForValidation(uuid: string): Promise<string> {\n    log.info('Waiting for Validation...');\n    return this.waitRetry(\n      (detailResponseData): string | null => {\n        if (!detailResponseData.processed) {\n          return null;\n        }\n\n        log.info('Validation results:', detailResponseData.validation);\n        if (detailResponseData.valid) {\n          return detailResponseData.uuid;\n        }\n\n        log.info('Validation failed.');\n        throw new Error(\n          'Validation failed, open the following URL for more information: ' +\n          `${detailResponseData.url}`\n        );\n      },\n      new URL(`upload/${uuid}/`, this.apiUrl),\n      this.validationCheckInterval,\n      this.validationCheckTimeout,\n      'Validation',\n    );\n  }\n\n  async doNewAddonSubmit(uuid: string, metaDataJson: Object): Promise<any> {\n    const url = new URL('addon/', this.apiUrl);\n    const jsonData = {\n      ...metaDataJson, version: { upload: uuid, ...metaDataJson.version },\n    };\n    return this.fetchJson(url, 'POST', JSON.stringify(jsonData));\n  }\n\n  doNewAddonOrVersionSubmit(\n    addonId: string,\n    uuid: string,\n    metaDataJson: Object,\n  ): Promise<typeof Response> {\n    const url = new URL(`addon/${addonId}/`, this.apiUrl);\n    const jsonData = {\n      ...metaDataJson, version: { upload: uuid, ...metaDataJson.version },\n    };\n    return this.fetch(url, 'PUT', JSON.stringify(jsonData));\n  }\n\n  waitForApproval(addonId: string, versionId: number): Promise<string> {\n    log.info('Waiting for Approval...');\n    return this.waitRetry(\n      (detailResponseData): string | null => {\n        const {file} = detailResponseData;\n        if (file && file.status === 'public') {\n          return file.url;\n        }\n\n        return null;\n      },\n      new URL(`addon/${addonId}/versions/${versionId}/`, this.apiUrl),\n      this.approvalCheckInterval,\n      this.approvalCheckTimeout,\n      'Approval',\n    );\n  }\n\n  async fetchJson(\n    url: URL,\n    method: string = 'GET',\n    body?: typeof FormData | string,\n    errorMsg: string = 'Bad Request'\n  ): Promise<any> {\n    const response = await this.fetch(url, method, body);\n    if (response.status < 200 || response.status >= 500) {\n      throw new Error(\n        `${errorMsg}: ${response.statusText || response.status}.`\n      );\n    }\n    const data = await response.json();\n\n    if (!response.ok) {\n      log.info('Server Response:', data);\n      throw new Error(\n        `${errorMsg}: ${response.statusText || response.status}.`);\n    }\n    return data;\n  }\n\n  async fetch(\n    url: URL,\n    method: string = 'GET',\n    body?: typeof FormData | string,\n  ): Promise<typeof Response> {\n    log.info(`Fetching URL: ${url.href}`);\n    let headers = {\n      Authorization: await this.apiAuth.getAuthHeader(),\n      Accept: 'application/json',\n    };\n    if (typeof body === 'string') {\n      headers = {\n        ...headers,\n        'Content-Type': 'application/json',\n      };\n    }\n    return this.nodeFetch(url, { method, body, headers });\n  }\n\n  async downloadSignedFile(\n    fileUrl: URL,\n    addonId: string\n  ): Promise<SignResult> {\n    const filename = fileUrl.pathname.split('/').pop(); // get the name from fileUrl\n    const dest = `${this.downloadDir}/${filename}`;\n    try {\n      const response = await this.fetch(fileUrl);\n      if (!response.ok || !response.body) {\n        throw new Error(`response status was ${response.status}`);\n      }\n      await this.saveToFile(response.body, dest);\n    } catch (error) {\n      log.info(`Download of signed xpi failed: ${error}.`);\n      throw new Error(`Downloading ${filename} failed`);\n    }\n    return {\n      id: addonId,\n      downloadedFiles: [filename],\n    };\n  }\n\n  async saveToFile(\n    contents: typeof Response.body, destPath: string): Promise<any> {\n    return promisify(pipeline)(contents, createWriteStream(destPath));\n  }\n\n  async postNewAddon(\n    xpiPath: string,\n    channel: string,\n    savedIdPath: string,\n    metaDataJson: Object,\n    saveIdToFileFunc: (string, string) => Promise<void> = saveIdToFile,\n  ): Promise<SignResult> {\n    const uploadUuid = await this.doUploadSubmit(xpiPath, channel);\n\n    const versionObject =\n      channel === 'listed' ? 'current_version' : 'latest_unlisted_version';\n    const {\n      guid: addonId,\n      [versionObject]: {id: newVersionId},\n    } = await this.doNewAddonSubmit(uploadUuid, metaDataJson);\n\n    await saveIdToFileFunc(savedIdPath, addonId);\n    log.info(`Generated extension ID: ${addonId}.`);\n    log.info('You must add the following to your manifest:');\n    log.info(`\"browser_specific_settings\": {\"gecko\": {\"id\": \"${addonId}\"}}`);\n\n    const fileUrl = new URL(await this.waitForApproval(addonId, newVersionId));\n\n    return this.downloadSignedFile(fileUrl, addonId);\n  }\n\n  async putVersion(\n    xpiPath: string,\n    channel: string,\n    addonId: string,\n    metaDataJson: Object\n  ): Promise<SignResult> {\n    const uploadUuid = await this.doUploadSubmit(xpiPath, channel);\n\n    await this.doNewAddonOrVersionSubmit(addonId, uploadUuid, metaDataJson);\n\n    const url = new URL(\n      `addon/${addonId}/versions/?filter=all_with_unlisted`, this.apiUrl\n    );\n    const {results: [{id: newVersionId}]} = await this.fetchJson(url);\n\n    const fileUrl = new URL(await this.waitForApproval(addonId, newVersionId));\n\n    return this.downloadSignedFile(fileUrl, addonId);\n  }\n}\n\ntype signAddonParams = {|\n  apiKey: string,\n  apiSecret: string,\n  amoBaseUrl: string,\n  timeout: number,\n  id?: string,\n  xpiPath: string,\n  downloadDir: string,\n  channel: string,\n  savedIdPath: string,\n  metaDataJson?: Object,\n  SubmitClient?: typeof Client,\n  ApiAuthClass?: typeof JwtApiAuth,\n|}\n\nexport async function signAddon({\n  apiKey,\n  apiSecret,\n  amoBaseUrl,\n  timeout,\n  id,\n  xpiPath,\n  downloadDir,\n  channel,\n  savedIdPath,\n  metaDataJson = {},\n  SubmitClient = Client,\n  ApiAuthClass = JwtApiAuth,\n}: signAddonParams): Promise<SignResult> {\n  try {\n    const stats = await fsPromises.stat(xpiPath);\n\n    if (!stats.isFile()) {\n      throw new Error(`not a file: ${xpiPath}`);\n    }\n  } catch (statError) {\n    throw new Error(`error with ${xpiPath}: ${statError}`);\n  }\n\n  let baseUrl;\n  try {\n    baseUrl = new URL(amoBaseUrl);\n  } catch (err) {\n    throw new Error(`Invalid AMO API base URL: ${amoBaseUrl}`);\n  }\n\n  const client = new SubmitClient({\n    apiAuth: new ApiAuthClass({ apiKey, apiSecret }),\n    baseUrl,\n    validationCheckTimeout: timeout,\n    approvalCheckTimeout: timeout,\n    downloadDir,\n  });\n\n  // We specifically need to know if `id` has not been passed as a parameter because\n  // it's the indication that a new add-on should be created, rather than a new version.\n  if (id === undefined) {\n    return client.postNewAddon(xpiPath, channel, savedIdPath, metaDataJson);\n  }\n\n  return client.putVersion(xpiPath, channel, id, metaDataJson);\n}\n\nexport async function saveIdToFile(\n  filePath: string, id: string\n): Promise<void> {\n  await fsPromises.writeFile(filePath, [\n    '# This file was created by https://github.com/mozilla/web-ext',\n    '# Your auto-generated extension ID for addons.mozilla.org is:',\n    id.toString(),\n  ].join('\\n'));\n\n  log.debug(`Saved auto-generated ID ${id} to ${filePath}`);\n}"],"mappings":"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"}