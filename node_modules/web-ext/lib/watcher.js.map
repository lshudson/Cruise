{"version":3,"file":"watcher.js","names":["fs","Watchpack","debounce","UsageError","createLogger","log","import","meta","url","onSourceChange","sourceDir","watchFile","watchIgnored","artifactsDir","onChange","shouldWatchFile","debounceTime","ignored","process","platform","map","it","replace","watcher","executeImmediately","on","filePath","proxyFileChanges","debug","join","watchedDirs","watchedFiles","existsSync","lstatSync","isFile","push","watch","files","directories","missing","startTime","Date","now","close","indexOf","toTimeString"],"sources":["../src/watcher.js"],"sourcesContent":["/* @flow */\nimport {fs} from 'mz';\nimport Watchpack from 'watchpack';\nimport debounce from 'debounce';\n\nimport { UsageError } from './errors.js';\nimport {createLogger} from './util/logger.js';\n\nconst log = createLogger(import.meta.url);\n\n\n// onSourceChange types and implementation\n\nexport type ShouldWatchFn = (filePath: string) => boolean;\n\nexport type OnChangeFn = () => any;\n\nexport type OnSourceChangeParams = {|\n  sourceDir: string,\n  watchFile?: Array<string>,\n  watchIgnored?: Array<string>,\n  artifactsDir: string,\n  onChange: OnChangeFn,\n  shouldWatchFile: ShouldWatchFn,\n  debounceTime?: number,\n|};\n\nexport type OnSourceChangeFn = (params: OnSourceChangeParams) => Watchpack;\n\nexport default function onSourceChange(\n  {\n    sourceDir,\n    watchFile,\n    watchIgnored,\n    artifactsDir,\n    onChange,\n    shouldWatchFile,\n    debounceTime = 500,\n  }: OnSourceChangeParams\n): Watchpack {\n  // When running on Windows, transform the ignored paths and globs\n  // as Watchpack does translate the changed files path internally\n  // (See https://github.com/webpack/watchpack/blob/v2.1.1/lib/DirectoryWatcher.js#L99-L103).\n  const ignored = (watchIgnored && process.platform === 'win32')\n    ? watchIgnored.map((it) => it.replace(/\\\\/g, '/'))\n    : watchIgnored;\n\n  // TODO: For network disks, we would need to add {poll: true}.\n  const watcher = ignored ?\n    new Watchpack({ignored}) :\n    new Watchpack();\n\n  // Allow multiple files to be changed before reloading the extension\n  const executeImmediately = false;\n  onChange = debounce(onChange, debounceTime, executeImmediately);\n\n  watcher.on('change', (filePath) => {\n    proxyFileChanges({artifactsDir, onChange, filePath, shouldWatchFile});\n  });\n\n  log.debug(\n    `Watching ${watchFile ? watchFile.join(',') : sourceDir} for changes`\n  );\n\n  const watchedDirs = [];\n  const watchedFiles = [];\n\n  if (watchFile) {\n    for (const filePath of watchFile) {\n      if (fs.existsSync(filePath) && !fs.lstatSync(filePath).isFile()) {\n        throw new UsageError('Invalid --watch-file value: ' +\n          `\"${filePath}\" is not a file.`);\n      }\n\n      watchedFiles.push(filePath);\n    }\n  } else {\n    watchedDirs.push(sourceDir);\n  }\n\n  watcher.watch({\n    files: watchedFiles,\n    directories: watchedDirs,\n    missing: [],\n    startTime: Date.now(),\n  });\n\n  // TODO: support interrupting the watcher on Windows.\n  // https://github.com/mozilla/web-ext/issues/225\n  process.on('SIGINT', () => watcher.close());\n  return watcher;\n}\n\n\n// proxyFileChanges types and implementation.\n\nexport type ProxyFileChangesParams = {|\n  artifactsDir: string,\n  onChange: OnChangeFn,\n  filePath: string,\n  shouldWatchFile: ShouldWatchFn,\n|};\n\nexport function proxyFileChanges(\n  {artifactsDir, onChange, filePath, shouldWatchFile}: ProxyFileChangesParams\n): void {\n  if (filePath.indexOf(artifactsDir) === 0 || !shouldWatchFile(filePath)) {\n    log.debug(`Ignoring change to: ${filePath}`);\n  } else {\n    log.debug(`Changed: ${filePath}`);\n    log.debug(`Last change detection: ${(new Date()).toTimeString()}`);\n    onChange();\n  }\n}\n"],"mappings":"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"}